# vim: set sts=2 ts=8 sw=2 tw=99 et ft=python:
import os, sys

projectName = 'rcbot'

sourceFiles = [
  "rcbot2/bot.cpp",
  "rcbot2/bot_accessclient.cpp",
  "rcbot2/bot_buttons.cpp",
  "rcbot2/bot_client.cpp",
  "rcbot2/bot_commands.cpp",
  "rcbot2/bot_configfile.cpp",
  "rcbot2/bot_coop.cpp",
  "rcbot2/bot_css_bot.cpp",
  "rcbot2/bot_dod_bot.cpp",
  "rcbot2/bot_dod_mod.cpp",
  "rcbot2/bot_events.cpp",
  "rcbot2/bot_fortress.cpp",
  "rcbot2/bot_ga.cpp",
  "rcbot2/bot_ga_ind.cpp",
  "rcbot2/bot_getprop.cpp",
  "rcbot2/bot_globals.cpp",
  "rcbot2/bot_hl1dmsrc.cpp",
  "rcbot2/bot_hldm_bot.cpp",
  "rcbot2/bot_kv.cpp",
  "rcbot2/bot_menu.cpp",
  "rcbot2/bot_mods.cpp",
  "rcbot2/bot_mtrand.cpp",
  "rcbot2/bot_navmesh.cpp",
  "rcbot2/bot_perceptron.cpp",
  "rcbot2/bot_profile.cpp",
  "rcbot2/bot_profiling.cpp",
  "rcbot2/bot_schedule.cpp",
  "rcbot2/bot_tf2_points.cpp",
  "rcbot2/bot_som.cpp",
  "rcbot2/bot_squads.cpp",
  "rcbot2/bot_strings.cpp",
  "rcbot2/bot_task.cpp",
  "rcbot2/bot_tf2_mod.cpp",
  "rcbot2/bot_utility.cpp",
  "rcbot2/bot_visibles.cpp",
  "rcbot2/bot_waypoint.cpp",
  "rcbot2/bot_waypoint_locations.cpp",
  "rcbot2/bot_waypoint_visibility.cpp",
  "rcbot2/bot_weapons.cpp",
  "rcbot2/bot_wpt_dist.cpp",
  "rcbot2/bot_zombie.cpp",
  "rcbot2/bot_sigscan.cpp",
  "rcbot2/bot_cvars.cpp",
  "rcbot2/bot_plugin_meta.cpp",
  "rcbot2/logging.cpp",
]

include_paths = [
  os.path.join(builder.currentSourcePath, 'rcbot2'),
]

compiler_defines = []

# Build with SourceMod extension support if --sm-path was specified
if builder.options.sm_path:
  include_paths += [
    os.path.join(builder.options.sm_path, 'sourcepawn', 'include'),
    os.path.join(builder.options.sm_path, 'public', 'amtl'),
    os.path.join(builder.options.sm_path, 'public', 'amtl', 'amtl'),
    os.path.join(builder.options.sm_path, 'public'),
    os.path.join(builder.currentSourcePath, 'sm_ext'),
  ]

  sourceFiles += [
    os.path.join(builder.currentSourcePath, 'sm_ext', 'smsdk_config.cpp'),
    os.path.join(builder.currentSourcePath, 'sm_ext', 'bot_sm_ext.cpp'),
    os.path.join(builder.currentSourcePath, 'sm_ext', 'bot_sm_natives.cpp'),
  ]
  
  compiler_defines += [ 'SM_EXT', ]

# List of SDK names that require hooks on runcmd
mods_requiring_runcmd_overrides = [
  # hack: DOD:S uses `Bot_Think`, which forces all `bot`-spawned entities to use Valve's
  # default bot AI.  we'll hook into their RunPlayerMove for now, but for consistency across
  # games it'd be better to supercede `Bot_Think` (or `Bot_RunAll` higher up the call stack)
  'dods',
]

###############
# Make sure to edit PackageScript, which copies your files to their appropriate locations
# Simple extensions do not need to modify past this point.

# set up the build info
include_paths += [ os.path.join(builder.currentSourcePath, 'versioning'), ]
sourceFiles += [ os.path.join(builder.currentSourcePath, 'versioning', 'build_info.cpp'), ]

if os.path.isfile(os.path.join(builder.currentSourcePath, 'sdk', 'smsdk_ext.cpp')):
  # Use the copy included in the project
  # sourceFiles += [os.path.join('sdk', 'smsdk_ext.cpp')]
  pass
else:
  # Use the copy included with SM 1.6 and newer
  # sourceFiles += [os.path.join(MMS.sm_root, 'public', 'smsdk_ext.cpp')]
  pass

for sdk_name in MMS.sdks:
  for arch in MMS.archs:
    sdk = MMS.sdks[sdk_name]

    if not arch in sdk.platformSpec[builder.target.platform]:
      continue

    name = projectName + '.' + sdk.ext
    binary = MMS.HL2Library(builder, name, sdk, arch)

    binary.sources += sourceFiles

    cxx = binary.compiler
    if (cxx.version >= 'gcc-4.0') or cxx.family == 'clang':
      cxx.cflags += [ '-Dstrcmpi=strcasecmp', ]

    if cxx.family == 'msvc':
      # suppress macro redefinition of 'offsetof'
      cxx.cflags += [ '/wd4005' ]

    cxx.cxxincludes += include_paths
    cxx.defines += compiler_defines

    if sdk_name in mods_requiring_runcmd_overrides:
      cxx.defines += [ 'OVERRIDE_RUNCMD' ]

    # RCBot:  Library requires exceptions
    if '-fno-exceptions' in cxx.cflags: cxx.cflags.remove('-fno-exceptions')

    if builder.target.platform == 'linux':
      if sdk.name == 'episode1':
        lib_folder = os.path.join(sdk.path, 'linux_sdk')
      elif sdk.name in ['sdk2013', 'bms']:
        lib_folder = os.path.join(sdk.path, 'lib', 'public', 'linux32')
      elif arch == 'x64':
        lib_folder = os.path.join(sdk.path, 'lib', 'linux64')
      else:
        lib_folder = os.path.join(sdk.path, 'lib', 'linux')
    elif builder.target.platform == 'mac':
      if sdk.name in ['sdk2013', 'bms']:
        lib_folder = os.path.join(sdk.path, 'lib', 'public', 'osx32')
      elif arch == 'x64':
        lib_folder = os.path.join(sdk.path, 'lib', 'osx64')
      else:
        lib_folder = os.path.join(sdk.path, 'lib', 'mac')

    if sdk.name in ['css', 'hl2dm', 'dods', 'sdk2013', 'bms', 'tf2', 'l4d', 'nucleardawn', 'l4d2']:
      if builder.target.platform in ['linux', 'mac']:
        cxx.defines += ['NO_HOOK_MALLOC', 'NO_MALLOC_OVERRIDE']

    if builder.target.platform in ['linux', 'mac']:
      ## RCBot2: link other dependencies
      if sdk.name in ['sdk2013', 'bms']:
        cxx.postlink += [
          cxx.Dep(os.path.join(lib_folder, 'mathlib.a')),
          cxx.Dep(os.path.join(lib_folder, 'tier2.a')),
          cxx.Dep(os.path.join(lib_folder, 'tier3.a')),
        ]
      else:
        cxx.postlink += [
          cxx.Dep(os.path.join(lib_folder, 'mathlib_i486.a')),
          cxx.Dep(os.path.join(lib_folder, 'tier2_i486.a')),
          cxx.Dep(os.path.join(lib_folder, 'tier3_i486.a')),
        ]
      cxx.postlink += [
        'libvstdlib_srv.so',
        '-lm',
        '-ldl',
        '-lpthread'
      ]

    nodes = builder.Add(binary)
    MMS.binaries += [nodes]
